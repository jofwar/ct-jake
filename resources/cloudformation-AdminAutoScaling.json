{
    "Description":"CloudTrek Simple Autoscaler Admin",
    "Parameters":{
        "AdminSubnets":{
            "Description":"Subnets to deploy Admin instances into",
            "Type":"List<AWS::EC2::Subnet::Id>"
        },
        "CustomerTag":{
            "Description":"Customer Tag",
            "Type":"String"
        },
        "InstanceSize":{
            "Default":"t2.medium",
            "Description":"Size of the instances to spin up",
            "Type":"String"
        },
        "KeyName":{
            "Description":"Name of an existing EC2 KeyPair to enable SSH/RDP access to the instance",
            "Type":"String"
        },
        "RoleName":{
            "Description":"EC2 Role Name to apply to the instance",
            "Type":"String"
        },
        "SecurityGroup":{
            "Description":"Security Group Ids to apply to this instance",
            "Type":"List<AWS::EC2::SecurityGroup::Id>"
        },
        "MinimumSize":{
            "Description":"Minimum Number of Admin Instances",
            "Type":"String",
            "Default":"0",
            "AllowedValues":[
                "0",
                "1",
                "2",
                "3"
            ]
        },
        "MaximumSize":{
            "Description":"Maximum Number of Admin Instances",
            "Type":"String",
            "Default":"1"
        },
        "OSVolumeSize":{
            "Description":"OS Volume (C drive) Size in Gb",
            "Type":"Number",
            "Default":"50",
            "MinValue":"30",
            "MaxValue":"1024",
            "ConstraintDescription":"OS Volume Size must be a value between 30 and 1024"
        },
        "OSVolumeType":{
            "Descroption":"Type of the OS volume",
            "Type":"String",
            "Default":"gp2",
            "AllowedValues":[
                "standard",
                "gp2"
            ]
        }
    },
    "Mappings":{
        "RegionMap":{
            "ap-southeast-2":{
                "AMI":"ami-7bda9041"
            },
            "eu-west-1":{
                "AMI":"ami-2fcbf458"
            }
        },
        "AvailabilityZones":{
            "ap-southeast-2":{
                "ZoneA":"ap-southeast-2a",
                "ZoneB":"ap-southeast-2b"
            },
            "eu-west-1":{
                "ZoneA":"eu-west-1a",
                "ZoneB":"eu-west-1b"
            }
        }
    },
    "Resources":{
        "AutoscalingGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
                "AvailabilityZones":[
                    {
                        "Fn::FindInMap":[
                            "AvailabilityZones",
                            {
                                "Ref":"AWS::Region"
                            },
                            "ZoneA"
                        ]
                    },
                    {
                        "Fn::FindInMap":[
                            "AvailabilityZones",
                            {
                                "Ref":"AWS::Region"
                            },
                            "ZoneB"
                        ]
                    }
                ],
                "HealthCheckType":"EC2",
                "LaunchConfigurationName":{
                    "Ref":"LaunchConfiguration"
                },
                "MaxSize":{
                    "Ref":"MaximumSize"
                },
                "MinSize":{
                    "Ref":"MinimumSize"
                },
                "DesiredCapacity":{
                    "Ref":"MinimumSize"
                },
                "Tags":[
                    {
                        "Key":"start-stop",
                        "PropagateAtLaunch":"true",
                        "Value":"0 7 * * *"
                    },
                    {
                        "Key":"Customer",
                        "PropagateAtLaunch":"true",
                        "Value":{
                            "Ref":"CustomerTag"
                        }
                    },
                    {
                        "Key":"Name",
                        "PropagateAtLaunch":"true",
                        "Value":"CORE-ADM"
                    }
                ],
                "VPCZoneIdentifier":{
                    "Ref":"AdminSubnets"
                }
            },
            "UpdatePolicy":{
                "AutoScalingRollingUpdate":{
                    "MaxBatchSize":"1",
                    "MinInstancesInService":"1",
                    "PauseTime":"PT15M",
                    "WaitOnResourceSignals":"true"
                }
            }
        },
        "LaunchConfiguration":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Metadata":{
                "AWS::CloudFormation::Authentication":{
                    "RoleAccess":{
                        "roleName":{
                            "Ref":"RoleName"
                        },
                        "type":"S3",
                        "buckets":[
                            "cloudtrek-customers-deployment"
                        ]
                    }
                },
                "AWS::CloudFormation::Init":{
                    "AdminAppsInstall":{
                        "commands":{
                            "1-SQLServerStudio":{
                                "command":"c:\\Temp\\SQLManagementStudio_x64_ENU.exe /Q /IACCEPTSQLSERVERLICENSETERMS /ACTION=install /FEATURES=Tools",
                                "ignoreErrors":"true",
                                "waitAfterCompletion":"1"
                            },
                            "2-sevenzip":{
                                "command":"c:\\Temp\\7z938-x64.msi /q",
                                "ignoreErrors":"true",
                                "waitAfterCompletion":"1"
                            },
                            "3-CloudBerryExplorer":{
                                "command":"c:\\Temp\\CloudBerryExplorerSetup_v4.0.7.38_netv4.0.exe /S",
                                "ignoreErrors":"true",
                                "waitAfterCompletion":"1"
                            }
                        },
                        "files":{
                            "c:\\Temp\\7z938-x64.msi":{
                                "authentication":"RoleAccess",
                                "source":"https://s3-ap-southeast-2.amazonaws.com/cloudtrek-customers-deployment/7z938-x64.msi"
                            },
                            "c:\\Temp\\CloudBerryExplorerSetup_v4.0.7.38_netv4.0.exe":{
                                "authentication":"RoleAccess",
                                "source":"https://s3-ap-southeast-2.amazonaws.com/cloudtrek-customers-deployment/CloudBerryExplorerSetup_v4.0.7.38_netv4.0.exe"
                            },
                            "c:\\Temp\\SQLManagementStudio_x64_ENU.exe":{
                                "authentication":"RoleAccess",
                                "source":"https://s3-ap-southeast-2.amazonaws.com/cloudtrek-customers-deployment/SQLManagementStudio_x64_ENU.exe"
                            }
                        }
                    },
                    "configSets":{
                        "ascending":[
                            "AdminAppsInstall"
                        ]
                    }
                }
            },
            "Properties":{
                "AssociatePublicIpAddress":"true",
                "BlockDeviceMappings":[
                    {
                        "DeviceName":"/dev/sda1",
                        "Ebs":{
                            "VolumeType":{
                                "Ref":"OSVolumeType"
                            },
                            "DeleteOnTermination":"true",
                            "VolumeSize":{
                                "Ref":"OSVolumeSize"
                            }
                        }
                    }
                ],
                "IamInstanceProfile":{
                    "Ref":"RoleName"
                },
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",
                        {
                            "Ref":"AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "InstanceType":{
                    "Ref":"InstanceSize"
                },
                "KeyName":{
                    "Ref":"KeyName"
                },
                "SecurityGroups":{
                    "Ref":"SecurityGroup"
                },
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -s ",
                                {
                                    "Ref":"AWS::StackName"
                                },
                                " -r LaunchConfiguration",
                                " --region ",
                                {
                                    "Ref":"AWS::Region"
                                },
                                " --configsets ascending -v --role ",
                                {
                                    "Ref":"RoleName"
                                },
                                "\n",
                                "cfn-signal -e 0",
                                " --resource AutoscalingGroup",
                                " --stack ",
                                {
                                    "Ref":"AWS::StackName"
                                },
                                " --region ",
                                {
                                    "Ref":"AWS::Region"
                                },
                                "\n</script>"
                            ]
                        ]
                    }
                }
            }
        }
    },
    "Outputs":{
        "AutoScalingGroupID":{
            "Description":"Logical ID of the Autoscaling Group",
            "Value":{
                "Ref":"AutoscalingGroup"
            }
        }
    }
}
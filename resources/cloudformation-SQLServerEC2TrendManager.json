{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"AWS CloudFormation template to deploy Scenario 1 resources for RACQ.  1 Oracle RDS, 1 SQL RDS inside the VPC",
    "Parameters":{
        "VpcId":{
            "Type":"String",
            "Description":"VpcId of your existing Virtual Private Cloud (VPC)"
        },
        "RDBMSSubnet":{
            "Type":"CommaDelimitedList",
            "Description":"The list of RDBMS SubnetIds, one in each Availability Zone in the region in your Virtual Private Cloud (VPC)"
        },
        "Environment":{
            "Type":"String",
            "Description":"Environment to append to the instance name"
        },
        "Customer":{
          "Decription":"Name of the customer",
            "Type": "String"
        },
        "SQLEC2Class":{
            "Default":"m3.large",
            "Description":"Database instance class",
            "Type":"String",
            "AllowedValues":[
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "c1.medium",
                "c1.xlarge",
                "c3.large",
                "c3.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "cr1.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge",
                "hi1.4xlarge",
                "i2.xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "hs1.8xlarge"
            ],
            "ConstraintDescription":"must be an valid EC2 instance type"
        },
        "SQLDataStorage":{
            "Default":"20",
            "Description":"The size of the data volume for the SQL database server (Gb)",
            "Type":"Number",
            "MinValue":"20",
            "MaxValue":"1024",
            "ConstraintDescription":"must be between 20 and 1024Gb."
        },
        "SQLLogStorage":{
            "Default":"10",
            "Description":"The size of the log volume for the SQL database server (Gb)",
            "Type":"Number",
            "MinValue":"10",
            "MaxValue":"1024",
            "ConstraintDescription":"must be between 20 and 1024Gb."
        },
        "SQLServerHA":{
            "Default":"false",
            "Description":"Boolean to build a second SQL Server to allow for High Availability",
            "Type":"String",
            "AllowedValues":[
                "true",
                "false"
            ]
        },
        "sgSQL":{
            "Description":"RDBMS Security Group ID",
            "Type":"String"
        },
        "IAMRole":{
            "Type":"String",
            "Description":"IAM role name to apply to the SQL instances"
        },
        "KeyName":{
            "Type":"String",
            "Description":"Name of the key to allow remote access"
        },
        "AssignElasticIP":{
        	"Default":"false",
        	"Type":"String",
        	"Description":"Assign an Elastic IP to the instance at startup",
        	"AllowedValues":[
                "true",
                "false"
            ]
        }	
    },
    "Conditions":{
        "Create2014":{
            "Fn::Equals":[
                {
                    "Ref":"SQLServer2014Boo"
                },
                "true"
            ]
        },
        "CreateHA2014":{
            "Fn::And":[
                {
                    "Condition":"Create2014"
                }
                ,
                {
                    "Condition":"CreateHA"
                }
            ]
        }
    },
    "Mappings":{
        "AWSInstanceType2Arch":{
            "m1.small":{
                "Arch":"64"
            },
            "m1.medium":{
                "Arch":"64"
            },
            "m1.large":{
                "Arch":"64"
            },
            "m1.xlarge":{
                "Arch":"64"
            },
            "m3.medium":{
                "Arch":"64"
            },
            "m3.large":{
                "Arch":"64"
            },
            "m3.xlarge":{
                "Arch":"64"
            },
            "m3.2xlarge":{
                "Arch":"64"
            },
            "c1.medium":{
                "Arch":"64"
            },
            "c1.xlarge":{
                "Arch":"64"
            },
            "c3.large":{
                "Arch":"64"
            },
            "c3.xlarge":{
                "Arch":"64"
            },
            "c3.2xlarge":{
                "Arch":"64"
            },
            "c3.4xlarge":{
                "Arch":"64"
            },
            "c3.8xlarge":{
                "Arch":"64"
            },
            "m2.xlarge":{
                "Arch":"64"
            },
            "m2.2xlarge":{
                "Arch":"64"
            },
            "m2.4xlarge":{
                "Arch":"64"
            },
            "cr1.8xlarge":{
                "Arch":"64"
            },
            "r3.large":{
                "Arch":"64"
            },
            "r3.xlarge":{
                "Arch":"64"
            },
            "r3.2xlarge":{
                "Arch":"64"
            },
            "r3.4xlarge":{
                "Arch":"64"
            },
            "r3.8xlarge":{
                "Arch":"64"
            },
            "hi1.4xlarge":{
                "Arch":"64"
            },
            "i2.xlarge":{
                "Arch":"64"
            },
            "i2.2xlarge":{
                "Arch":"64"
            },
            "i2.4xlarge":{
                "Arch":"64"
            },
            "i2.8xlarge":{
                "Arch":"64"
            },
            "hs1.8xlarge":{
                "Arch":"64"
            }
        },
        "Win2012SQL2014StandardAMI":{
            "ap-southeast-2":{
                "64":"ami-f53679cf"
            }
        }
    },
    "Resources":{       
         "SQLServer2014InstanceA":{
            "Type":"AWS::EC2::Instance",
            "Condition":"Create2014",
            "Properties":{
                "ImageId":{
                    "Fn::FindInMap":[
                        "Win2012SQL2014StandardAMI",
                        {
                            "Ref":"AWS::Region"
                        },
                        {
                            "Fn::FindInMap":[
                                "AWSInstanceType2Arch",
                                {
                                    "Ref":"SQLEC2Class"
                                },
                                "Arch"
                            ]
                        }
                    ]
                },
                "KeyName":{
                    "Ref":"KeyName"
                },
                "InstanceType":{
                    "Ref":"SQLEC2Class"
                },
                "NetworkInterfaces":[
                    {
                        "GroupSet":[
                            {
                                "Ref":"sgSQL"
                            }
                        ],
                        "DeleteOnTermination":"true",
                        "Description":"Primary network interface",
                        "DeviceIndex":0,
                        "SubnetId":{
                            "Fn::Select":[
                                "0",
                                {
                                    "Ref":"RDBMSSubnets"
                                }
                            ]
                        },
                        "AssociatePublicIpAddress":{
                            "Ref":"AssignElasticIP"
                        }
                    }
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Join":[
                                "-",
                                [
                                    {
                                        "Ref":"Environment"
                                    },
                                    "SQL2014A"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "SQL2014DataVolumeA":{
            "Type":"AWS::EC2::Volume",
            "Condition":"Create2014",
            "Properties":{
                "AvailabilityZone":{
                    "Fn::GetAtt":[
                        "SQLServer2014InstanceA",
                        "AvailabilityZone"
                    ]
                },
                "Size":{
                    "Ref":"SQLDataStorage"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Join":[
                                "-",
                                [
                                    {
                                        "Ref":"Environment"
                                    },
                                    "SQL2014A",
                                    "Data"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "SQL2014LogVolumeA":{
            "Type":"AWS::EC2::Volume",
            "Condition":"Create2014",
            "Properties":{
                "AvailabilityZone":{
                    "Fn::GetAtt":[
                        "SQLServer2014InstanceA",
                        "AvailabilityZone"
                    ]
                },
                "Size":{
                    "Ref":"SQLLogStorage"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Join":[
                                "-",
                                [
                                    {
                                        "Ref":"Environment"
                                    },
                                    "SQL2014A",
                                    "Log"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "SQL2014DataAttachmentA":{
            "Type":"AWS::EC2::VolumeAttachment",
            "Condition":"Create2014",
            "DependsOn":[
                "SQLServer2014InstanceA",
                "SQL2014DataVolumeA"
            ],
            "Properties":{
                "Device":"xvdf",
                "InstanceId":{
                    "Ref":"SQLServer2014InstanceA"
                },
                "VolumeId":{
                    "Ref":"SQL2014DataVolumeA"
                }
            }
        },
        "SQL2014LogAttachmentA":{
            "Type":"AWS::EC2::VolumeAttachment",
            "Condition":"Create2014",
            "DependsOn":[
                "SQLServer2014InstanceA",
                "SQL2014LogVolumeA"
            ],
            "Properties":{
                "Device":"xvdl",
                "InstanceId":{
                    "Ref":"SQLServer2014InstanceA"
                },
                "VolumeId":{
                    "Ref":"SQL2014LogVolumeA"
                }
            }
        }
    },
    "Outputs":{
        "SQLEndpoint2014A":{
            "Condition":"Create2014",
            "Value":{
                "Fn::GetAtt":[
                    "SQLServer2014InstanceA",
                    "PrivateIp"
                ]
            },
            "Description":"IP Address for the SQL Server 2014 Database Server, AZA"
        },
        "SQLEndpoint2014B":{
            "Condition":"CreateHA2014",
            "Value":{
                "Fn::GetAtt":[
                    "SQLServer2014InstanceB",
                    "PrivateIp"
                ]
            },
            "Description":"IP Address for the SQL Server 2014 Database Server, AZB"
        }
    }
}
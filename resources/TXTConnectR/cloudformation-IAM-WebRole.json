{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"IAM Role for Web Instance",
    "Resources":{
        "WebServerRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":"sts:AssumeRole",
                            "Principal":{
                                "Service":"ec2.amazonaws.com"
                            }
                        }
                    ]
                },
                "Path":"/"
            }
        },
        "WebServerRolePolicy":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
                "PolicyName":"WebServerRole",
                "PolicyDocument":{
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":[
                                "s3:GetObject"
                            ],
                            "Resource":"arn:aws:s3:::txtconnectr-mainwebsite-s3bucket-vwca8squ51fp/*"
                        },
                        {
                            "Effect":"Allow",
                            "Action":[
                                "s3:GetObject"
                            ],
                            "Resource":"arn:aws:s3:::webapp.txtconnectr.com/*"
                        },
                        {
                            "Effect":"Allow",
                            "Action":[
                                "cloudformation:SignalResource",
                                "cloudformation:DescribeStackResource"
                            ],
                            "Resource":"*"
                        },
                        {
                            "Effect":"Allow",
                            "Action":[
                                "ec2:AssociateAddress",
                                "ec2:DescribeNetworkInterfaces",
                                "ec2:DescribeNetworkInterfaceAttribute",
                                "ec2:DisassociateAddress"
                            ],
                            "Resource":"*"
                        },
                        {
                            "Sid":"BucketAccess",
                            "Action":[
                                "s3:Get*",
                                "s3:List*",
                                "s3:PutObject"
                            ],
                            "Effect":"Allow",
                            "Resource":[
                                "arn:aws:s3:::txtconnectr-mainwebsite-s3bucket-vwca8squ51fp-*-*/*",
                                "arn:aws:s3:::webapp.txtconnectr.com-*-*-*/*"
                            ]
                        },
                        {
                            "Sid":"ECSAccess",
                            "Effect":"Allow",
                            "Action":[
                                "ecs:StartTask",
                                "ecs:StopTask",
                                "ecs:RegisterContainerInstance",
                                "ecs:DeregisterContainerInstance",
                                "ecs:DescribeContainerInstances",
                                "ecs:DiscoverPollEndpoint",
                                "ecs:Submit*",
                                "ecs:Poll"
                            ],
                            "Resource":"*"
                        },
                        {
                            "Sid":"QueueAccess",
                            "Action":[
                                "sqs:ChangeMessageVisibility",
                                "sqs:DeleteMessage",
                                "sqs:ReceiveMessage",
                                "sqs:SendMessage"
                            ],
                            "Effect":"Allow",
                            "Resource":"*"
                        },
                        {
                            "Sid":"AuroraPeriodicTasks",
                            "Action":[
                                "auroradb:BatchGetItem",
                                "auroradb:BatchWriteItem",
                                "auroradb:DeleteItem",
                                "auroradb:GetItem",
                                "auroradb:PutItem",
                                "auroradb:Query",
                                "auroradb:Scan",
                                "auroradb:UpdateItem"
                            ],
                            "Effect":"Allow",
                            "Resource":[
                                "arn:aws:auroradb:*:*:table/*-stack-AWSEBWorkerCronLeaderRegistry*"
                            ]
                        },
                        {
                            "Sid":"MetricsAccess",
                            "Action":[
                                "cloudwatch:PutMetricData"
                            ],
                            "Effect":"Allow",
                            "Resource":"*"
                        }
                    ]
                },
                "Roles":[
                    {
                        "Ref":"WebServerRole"
                    }
                ]
            }
        },
        "WebServerInstanceProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
                "Path":"/",
                "Roles":[
                    {
                        "Ref":"WebServerRole"
                    }
                ]
            }
        }
    },
    "Outputs":{
        "RoleID":{
            "Value":{
                "Ref":"WebServerRole"
            }
        },
        "RoleARN":{
            "Value":{
                "Fn::GetAtt":[
                    "WebServerRole",
                    "Arn"
                ]
            }
        },
        "InstanceProfileARN":{
            "Value":{
                "Fn::GetAtt":[
                    "WebServerInstanceProfile",
                    "Arn"
                ]
            }
        }
    }
}
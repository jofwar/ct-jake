{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"AWS CloudFormationSample Template to create Elastic Beanstalk Compute Tier",
    "Parameters":{
        "KeyName":{
            "Description":"Name of an existing EC2 KeyPair to enable SSH access to the Elastic Beanstalk hosts",
            "Type":"AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription":"must be the name of an existing EC2 KeyPair."
        },
        "VpcId":{
            "Type":"AWS::EC2::VPC::Id",
            "Description":"VpcId of your existing Virtual Private Cloud (VPC)"
        },
        "Name":{
            "Description":"Name of the compute instances",
            "Type":"String",
            "MinLength":"3",
            "MaxLength":"255"
        },
        "Environment":{
            "Description":"Environment to allocate costs to",
            "Type":"String",
            "MinLength":"3",
            "MaxLength":"255"
        },
        "System":{
            "Description":"System to allocate costs to",
            "Type":"String",
            "MinLength":"3",
            "MaxLength":"255"
        },
        "ComputeSecurityGroups":{
            "Description":"Security group to apply to the Compute instances",
            "Type":"List<AWS::EC2::SecurityGroup::Id>"
        },
        "ComputeSubnets":{
            "Description":"Subnets to deploy the Compute instances into",
            "Type":"List<AWS::EC2::Subnet::Id>"
        },
        "IAMRole":{
            "Description":"IAM Role to attach to the EB instances",
            "Type":"String"
        },
        "S3Bucket":{
            "Description":"S3 Bucket the PHP stack is in",
            "Type":"String"
        },
        "S3Package":{
            "Description":"S3 Path to the PHP stack to deploy",
            "Type":"String"
        },
        "MinSize":{
            "Description":"Minimum number of instances in Elastic Beanstalk",
            "Default":"1",
            "Type":"String"
        },
        "MaxSize":{
            "Description":"Minimum number of instances in Elastic Beanstalk",
            "Default":"2",
            "Type":"String"
        },
        "ComputeInstanceType":{
            "Description":"Compute EC2 instance type",
            "Type":"String",
            "Default":"t1.micro",
            "AllowedValues":[
                "t2.micro",
                "t2.small",
                "t2.medium",
                "t2.large",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "c3.large",
                "c3.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "t1.micro",
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "c1.medium",
                "c1.xlarge",
                "c4.large",
                "c4.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "m4.large",
                "m4.xlarge",
                "m4.2xlarge",
                "m4.4xlarge",
                "m4.10xlarge",
                "cc1.4xlarge",
                "cc2.8xlarge",
                "hi1.4xlarge",
                "hs1.8xlarge",
                "cr1.8xlarge",
                "g2.2xlarge",
                "g2.8xlarge",
                "i2.xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ]
            ,
            "ConstraintDescription":"must be a valid EC2 instance type."
        },
        "SQSURL":{
            "Description":"The URL of the SQS queue from which the daemon in the worker environment tier reads messages",
            "Type":"String"
        },
        "URLforProcessing":{
            "Description":"The relative path to the application to which HTTP POST messages are sent",
            "Type":"String",
            "Default":"/"
        },
        "MIMEType":{
            "Description":"The MIME type of the message sent in the HTTP POST request to the worker",
            "Type":"String",
            "Default":"application/json"
        }
    },
    "Mappings":{
        "SubnetConfig": {
            "VPC": {
                "CIDR": "0.0/20"
            },
            "SubnetPrivateA": {
                "CIDR": "7.0/24"
            },
            "SubnetPrivateB": {
                "CIDR": "8.0/24"
            },
            "SubnetRivateC": {
                "CIDR": "9.0/24"
            },
            "SubnetPublicA": {
                "CIDR": "1.0/24"
            },
            "SubnetPublicB": {
                "CIDR": "2.0/24"
            },
            "SubnetPublicC": {
                "CIDR": "3.0/25"
            }
        },
        "AvailabilityZones":{
            "ap-southeast-2":{
                "ZoneA":"ap-southeast-2a",
                "ZoneB":"ap-southeast-2b"
            },
            "eu-west-1":{
                "ZoneA":"eu-west-1a",
                "ZoneB":"eu-west-1b"
            }
        },
        "AWSInstanceType2Arch":{
            "t1.micro":{
                "Arch":"PV64"
            },
            "t2.micro":{
                "Arch":"HVM64"
            },
            "t2.small":{
                "Arch":"HVM64"
            },
            "t2.medium":{
                "Arch":"HVM64"
            },
            "m3.medium":{
                "Arch":"HVM64"
            },
            "m3.large":{
                "Arch":"HVM64"
            },
            "m3.xlarge":{
                "Arch":"HVM64"
            },
            "m3.2xlarge":{
                "Arch":"HVM64"
            },
            "c4.large":{
                "Arch":"HVM64"
            },
            "r3.large":{
                "Arch":"HVM64"
            }
        },
        "AWSRegionArch2AMI":{
            "ap-southeast-2":{
                "PV64":"ami-fe280b9d",
                "HVM64":"ami-012e5c3b",
                "HVMG2":"ami-012e5c3b"
            }
        }
    },
    "Resources":{
        "ComputeApplication":{
            "Type":"AWS::ElasticBeanstalk::Application",
            "Properties":{
                "Description":"TXTConnectR Compute Application"
            }
        },
        "ComputeApplicationVersion":{
            "Type":"AWS::ElasticBeanstalk::ApplicationVersion",
            "Properties":{
                "ApplicationName":{
                    "Ref":"ComputeApplication"
                },
                "Description":"TXTConnectR Compute Application Version",
                "SourceBundle":{
                    "S3Bucket":{
                        "Ref":"S3Bucket"
                    },
                    "S3Key":{
                        "Ref":"S3Package"
                    }
                }
            }
        },
        "ComputeConfigurationTemplate":{
            "Type":"AWS::ElasticBeanstalk::ConfigurationTemplate",
            "Properties":{
                "ApplicationName":{
                    "Ref":"ComputeApplication"
                },
                "Description":"AWS ElasticBeanstalk Compute Configuration Template",
                "OptionSettings":[
                    {
                        "Namespace":"aws:autoscaling:asg",
                        "OptionName":"MinSize",
                        "Value":{
                            "Ref":"MinSize"
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:asg",
                        "OptionName":"MaxSize",
                        "Value":{
                            "Ref":"MaxSize"
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"IamInstanceProfile",
                        "Value":{
                            "Ref":"IAMRole"
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"EC2KeyName",
                        "Value":{
                            "Ref":"KeyName"
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"InstanceType",
                        "Value":{
                            "Ref":"ComputeInstanceType"
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"SecurityGroups",
                        "Value":{
                            "Fn::Join":[
                                ",",
                                {
                                    "Ref":"ComputeSecurityGroups"
                                }
                            ]
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"ImageId",
                        "Value":{
                            "Fn::FindInMap":[
                                "AWSRegionArch2AMI",
                                {
                                    "Ref":"AWS::Region"
                                },
                                {
                                    "Fn::FindInMap":[
                                        "AWSInstanceType2Arch",
                                        {
                                            "Ref":"ComputeInstanceType"
                                        },
                                        "Arch"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "Namespace":"aws:autoscaling:launchconfiguration",
                        "OptionName":"RootVolumeType",
                        "Value":"gp2"
                    },
                    {
                        "Namespace":"aws:ec2:vpc",
                        "OptionName":"VPCId",
                        "Value":{
                            "Ref":"VpcId"
                        }
                    },
                    {
                        "Namespace":"aws:ec2:vpc",
                        "OptionName":"Subnets",
                        "Value":{
                            "Fn::Join":[
                                ",",
                                {
                                    "Ref":"ComputeSubnets"
                                }
                            ]
                        }
                    },
                    {
                        "Namespace":"aws:ec2:vpc",
                        "OptionName":"AssociatePublicIpAddress",
                        "Value":"true"
                    },
                    {
                        "Namespace":"aws:elasticbeanstalk:environment",
                        "OptionName":"EnvironmentType",
                        "Value":"LoadBalanced"
                    },
                    {
                        "Namespace":"aws:elasticbeanstalk:sqsd",
                        "OptionName":"WorkerQueueURL",
                        "Value":{
                            "Ref":"SQSURL"
                        }
                    },
                    {
                        "Namespace":"aws:elasticbeanstalk:sqsd",
                        "OptionName":"HttpPath",
                        "Value":{
                            "Ref":"URLforProcessing"
                        }
                    },
                    {
                        "Namespace":"aws:elasticbeanstalk:sqsd",
                        "OptionName":"MimeType",
                        "Value":{
                            "Ref":"MIMEType"
                        }
                    }
                ],
                "SolutionStackName":"64bit Amazon Linux 2016.03 v2.1.0 running PHP 5.6"
            }
        },
        "ComputeEnvironment":{
            "Type":"AWS::ElasticBeanstalk::Environment",
            "Properties":{
                "ApplicationName":{
                    "Ref":"ComputeApplication"
                },
                "Description":"TXTConnectR Compute Environment",
                "EnvironmentName":{
                    "Ref":"Name"
                },
                "TemplateName":{
                    "Ref":"ComputeConfigurationTemplate"
                },
                "VersionLabel":{
                    "Ref":"ComputeApplicationVersion"
                },
                "Tier":{
                    "Name":"Worker",
                    "Type":"SQS/HTTP"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Join":[
                                "-",
                                [
                                    "eb",
                                    {
                                        "Ref":"System"
                                    },
                                    {
                                        "Ref":"Environment"
                                    },
                                    "privatecompute"
                                ]
                            ]
                        }
                    },
                    {
                        "Key":"Environment",
                        "Value":{
                            "Ref":"Environment"
                        }
                    },
                    {
                        "Key":"System",
                        "Value":{
                            "Ref":"System"
                        }
                    }
                ]
            }
        }
    }
}

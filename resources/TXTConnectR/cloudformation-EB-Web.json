{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormationSample Template to create Elastic Beanstalk Web Tier",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the Elastic Beanstalk hosts",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VpcId of your existing Virtual Private Cloud (VPC)"
    },
    "Name": {
      "Description": "Name of the web instances",
      "Type": "String",
      "MinLength": "3",
      "MaxLength": "255"
    },
    "Environment": {
      "Description": "Environment to allocate costs to",
      "Type": "String",
      "MinLength": "3",
      "MaxLength": "255"
    },
    "System": {
      "Description": "System to allocate costs to",
      "Type": "String",
      "MinLength": "3",
      "MaxLength": "255"
    },
    "WebSecurityGroups": {
      "Description": "Security group to apply to the Web instances",
      "Type": "List<AWS::EC2::SecurityGroup::Id>"
    },
    "WebSubnets": {
      "Description": "Subnets to deploy the Web instances into",
      "Type": "List<AWS::EC2::Subnet::Id>"
    },
    "IAMRole": {
      "Description": "IAM Role to attach to the EB instances",
      "Type": "String"
    },
    "S3Bucket": {
      "Description": "S3 Bucket the PHP stack is in",
      "Type": "String"
    },
    "S3Package": {
      "Description": "S3 Path to the PHP stack to deploy",
      "Type": "String"
    },
    "MinSize": {
      "Description": "Minimum number of instances in Elastic Beanstalk",
      "Default": "1",
      "Type": "String"
    },
    "MaxSize": {
      "Description": "Minimum number of instances in Elastic Beanstalk",
      "Default": "2",
      "Type": "String"
    },
    "WebInstanceType": {
      "Description": "Web EC2 instance type",
      "Type": "String",
      "Default": "t1.micro",
      "AllowedValues": [
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "t1.micro",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "c1.medium",
        "c1.xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "DocumentRoot": {
      "Description": "Path of the web root",
      "Default": "/.",
      "Type": "String"
    },
    "WebName": {
      "Description": "A prefix for your Elastic Beanstalk environment URL",
      "Default": "txtconnectr",
      "Type": "String"
    }
  },
  "Mappings": {
    "SubnetConfig": {
      "VPC": {
        "CIDR": "0.0/20"
      },
      "SubnetPrivateA": {
        "CIDR": "7.0/24"
      },
      "SubnetPrivateB": {
        "CIDR": "8.0/24"
      },
      "SubnetRivateC": {
        "CIDR": "9.0/24"
      },
      "SubnetPublicA": {
        "CIDR": "1.0/24"
      },
      "SubnetPublicB": {
        "CIDR": "2.0/24"
      },
      "SubnetPublicC": {
        "CIDR": "3.0/25"
      }
    },
    "AvailabilityZones": {
      "ap-southeast-2": {
        "ZoneA": "ap-southeast-2a",
        "ZoneB": "ap-southeast-2b",
        "ZoneC": "ap-southeast-2c"
      },
      "eu-west-1": {
        "ZoneA": "eu-west-1a",
        "ZoneB": "eu-west-1b"
      }
    },
    "AWSInstanceType2Arch": {
      "t1.micro": {
        "Arch": "PV64"
      },
      "t2.micro": {
        "Arch": "HVM64"
      },
      "t2.small": {
        "Arch": "HVM64"
      },
      "t2.medium": {
        "Arch": "HVM64"
      },
      "m3.medium": {
        "Arch": "HVM64"
      },
      "m3.large": {
        "Arch": "HVM64"
      },
      "m3.xlarge": {
        "Arch": "HVM64"
      },
      "m3.2xlarge": {
        "Arch": "HVM64"
      },
      "c4.large": {
        "Arch": "HVM64"
      },
      "r3.large": {
        "Arch": "HVM64"
      }
    },
    "AWSRegionArch2AMI":{
      "ap-southeast-2":{
        "PV64":"ami-fe280b9d",
        "HVM64":"ami-012e5c3b",
        "HVMG2":"ami-012e5c3b"
      }
    }
  },
  "Resources": {
    "WebApplication": {
      "Type": "AWS::ElasticBeanstalk::Application",
      "Properties": {
        "Description": "TXTConnectR Web Application"
      }
    },
    "WebApplicationVersion": {
      "Type": "AWS::ElasticBeanstalk::ApplicationVersion",
      "Properties": {
        "ApplicationName": {
          "Ref": "WebApplication"
        },
        "Description": "TXTConnectR Web Application Version",
        "SourceBundle": {
          "S3Bucket": {
            "Ref": "S3Bucket"
          },
          "S3Key": {
            "Ref": "S3Package"
          }
        }
      }
    },
    "WebConfigurationTemplate": {
      "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
      "Properties": {
        "ApplicationName": {
          "Ref": "WebApplication"
        },
        "Description": "AWS ElasticBeanstalk Web Configuration Template",
        "OptionSettings": [
          {
            "Namespace": "aws:autoscaling:asg",
            "OptionName": "MinSize",
            "Value": {
              "Ref": "MinSize"
            }
          },
          {
            "Namespace": "aws:autoscaling:asg",
            "OptionName": "MaxSize",
            "Value": {
              "Ref": "MaxSize"
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "IamInstanceProfile",
            "Value": {
              "Ref": "IAMRole"
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "EC2KeyName",
            "Value": {
              "Ref": "KeyName"
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "InstanceType",
            "Value": {
              "Ref": "WebInstanceType"
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "SecurityGroups",
            "Value": {
              "Fn::Join": [
                ",",
                {
                  "Ref": "WebSecurityGroups"
                }
              ]
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "ImageId",
            "Value": {
              "Fn::FindInMap": [
                "AWSRegionArch2AMI",
                {
                  "Ref": "AWS::Region"
                },
                {
                  "Fn::FindInMap": [
                    "AWSInstanceType2Arch",
                    {
                      "Ref": "WebInstanceType"
                    },
                    "Arch"
                  ]
                }
              ]
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "RootVolumeType",
            "Value": "gp2"
          },
          {
            "Namespace": "aws:ec2:vpc",
            "OptionName": "VPCId",
            "Value": {
              "Ref": "VpcId"
            }
          },
          {
            "Namespace": "aws:ec2:vpc",
            "OptionName": "Subnets",
            "Value": {
              "Fn::Join": [
                ",",
                {
                  "Ref": "WebSubnets"
                }
              ]
            }
          },
          {
            "Namespace": "aws:ec2:vpc",
            "OptionName": "ELBSubnets",
            "Value": {
              "Fn::Join": [
                ",",
                {
                  "Ref": "WebSubnets"
                }
              ]
            }
          },
          {
            "Namespace": "aws:ec2:vpc",
            "OptionName": "AssociatePublicIpAddress",
            "Value": "true"
          },
          {
            "Namespace": "aws:elasticbeanstalk:environment",
            "OptionName": "EnvironmentType",
            "Value": "LoadBalanced"
          },
          {
            "Namespace": "aws:elb:loadbalancer",
            "OptionName": "CrossZone",
            "Value": "true"
          },
          {
            "Namespace": "aws:elasticbeanstalk:container:php:phpini",
            "OptionName": "document_root",
            "Value": {
              "Ref": "DocumentRoot"
            }
          }
        ],
        "SolutionStackName": "64bit Amazon Linux 2016.03 v2.1.0 running PHP 5.6"
      }
    },
    "WebEnvironment": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
        "ApplicationName": {
          "Ref": "WebApplication"
        },
        "CNAMEPrefix": {
          "Ref": "WebName"
        },
        "Description": "Public Web Environment",
        "EnvironmentName": {
          "Ref": "Name"
        },
        "TemplateName": {
          "Ref": "WebConfigurationTemplate"
        },
        "VersionLabel": {
          "Ref": "WebApplicationVersion"
        },
        "Tier": {
          "Name": "WebServer",
          "Type": "Standard"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  "eb",
                  {
                    "Ref": "System"
                  },
                  {
                    "Ref": "Environment"
                  },
                  "publicweb"
                ]
              ]
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "System",
            "Value": {
              "Ref": "System"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "URL": {
      "Description": "The URL of the Elastic Beanstalk environment",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "WebEnvironment",
                "EndpointURL"
              ]
            }
          ]
        ]
      }
    }
  }
}

{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation template to deploy EC2 Instance customized for a TrendManager Installation",
  "Parameters": {
    "AttachEIP": {
      "Type": "String",
      "Description": "Attach Elastic IP to instance?",
      "Default": "true",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "SecurityGroup": {
      "Description": "The option to chose the Security Group that this instance will be a part of ",
      "Default": "sg-754f2f11,sg-724f2f16",
      "Type": "List<AWS::EC2::SecurityGroup::Id>"
    },
    "SubnetId": {
      "Description": "The SubnetId",
      "Default": "subnet-63ced214",
      "Type": "String"
    },
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair",
      "Default": "CUSTOMERS-CORE-TREND",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "Customer": {
      "Description": "The Customer tag to allocate costs to",
      "Default": "CTShared",
      "Type": "String"
    },
    "Name": {
      "Description": "The Name tag to allocate costs to",
      "Type": "String",
      "Default": "CoreTrend",
      "MinLength": "3",
      "MaxLength": "255"
    },
    "RoleParam": {
      "Description": "IAM role for Web Server",
      "Default": "core-trend",
      "Type": "String"
    },
    "AddressAndPortsScreenManagerAddress": {
      "Description": "Trend software Parameters. Port used for applications and agent connecitons",
      "Type": "String",
      "Default": "localhost"
    },
    "AddressAndPortsScreenNewNode": {
      "Description": "Trend software Parameters. Relevant between a new and an old installation",
      "Type": "String",
      "Default": "True",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "UpgradeVerificationScreenOverwrite": {
      "Description": "JAKE",
      "Type": "String",
      "Default": "False",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "LicenseScreenLicense": {
      "Description": "Trend License Key",
      "Type": "String"
    },
    "DatabaseScreenDatabaseType": {
      "Description": "Type of Database to install",
      "Type": "String",
      "Default": "Embedded Microsoft SQL Server Express",
      "AllowedValues": [
        "Embedded Microsoft SQL Server Express",
        "Microsoft SQL Server",
        "Oracle"
      ]
    },
    "DatabaseScreenPassword": {
      "Description": "Trend software Parameters. The password for the DataBase Screen",
      "Type": "String"
    },
    "AddressAndPortsScreenManagerPort": {
      "Description": "Trend software Parameters. Port used for management communications",
      "Type": "String",
      "Default": "4119",
      "AllowedValues": [
        "4119"
      ]
    },
    "AddressAndPortsScreenHeartbeatPort": {
      "Description": "Trend software Parameters. Port used for applications and agent connecitons",
      "Type": "String",
      "Default": "4120",
      "AllowedValues": [
        "4120"
      ]
    },
    "CredentialsScreenAdministratorUsername": {
      "Description": "Trend software Parameters. Username for master administrator",
      "Type": "String",
      "Default": "masteradmin"
    },
    "CredentialsScreenAdministratorPassword": {
      "Description": "Trend software Parameters. Password for master administrator",
      "Type": "String"
    },
    "CredentialsScreenUseStrongPasswords": {
      "Description": "Trend software Parameters. The use of strong passwords is required",
      "Type": "String",
      "Default": "False",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "SecurityUpdateScreenUpdateComponents": {
      "Description": "Trend software Parameters. Indicitive of whether or not to recieve automatic updates",
      "Type": "String",
      "Default": "True",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "SoftwareUpdateScreenUpdateSoftware": {
      "Description": "Trend software Parameters. Check for new package updates",
      "Type": "String",
      "Default": "True",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "RelayScreenInstall": {
      "Description": "JAKE.",
      "Type": "String",
      "Default": "False",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "SmartProtectionNetworkScreenEnableFeedback": {
      "Description": "Trend software Parameters. Optional to provide installation feedback.",
      "Type": "String"
    },
    "InstanceType": {
      "Description": "Amazon EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t1.micro",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m1.medium",
        "m3.medium",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "g2.2xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "BuildBucket": {
      "Description": "Bucket the build files come from",
      "Type": "String",
      "Default": "cloudtrek-customers-deployment"
    }
  },
  "Conditions": {
    "NeedsEIP": {
      "Fn::Equals": [
        {
          "Ref": "AttachEIP"
        },
        "true"
      ]
    }
  },
  "Mappings": {
    "AWSRegion2AMI": {
      "eu-west-1": {
        "Windows2012r2": "ami-50e67823"
      },
      "ap-southeast-2": {
        "Windows2012r2": "ami-83b198e0"
      }
    }
  },
  "Resources": {
    "PublicIP": {
      "Condition": "NeedsEIP",
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "PublicIPAttachment": {
      "Type": "AWS::EC2::EIPAssociation",
      "Condition": "NeedsEIP",
      "DependsOn": "PublicIP",
      "Properties": {
        "InstanceId": {
          "Ref": "TrendManager"
        },
        "AllocationId": {
          "Fn::GetAtt": [
            "PublicIP",
            "AllocationId"
          ]
        }
      }
    },
    "TrendManager": {
      "Type": "AWS::EC2::Instance",
      "Metadata": {
        "AWS::CloudFormation::Authentication": {
          "RoleAccess": {
            "buckets": [
              {
                "Ref": "BuildBucket"
              }
            ],
            "roleName": {
              "Ref": "RoleParam"
            },
            "type": "S3"
          }
        },
        "AWS::CloudFormation::Init": {
          "config": {
            "files": {
              "c:\\cfn\\cfn-hup.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[main]\n",
                      "stack=",
                      {
                        "Ref": "AWS::StackId"
                      },
                      "\n",
                      "region=",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n"
                    ]
                  ]
                }
              },
              "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[cfn-auto-reloader-hook]\n",
                      "triggers=post.update\n",
                      "path=Resources.TrendManager.Metadata.AWS::CloudFormation::Init\n",
                      "action=cfn-init.exe -v -s ",
                      {
                        "Ref": "AWS::StackId"
                      },
                      " -r TrendManager",
                      " --region ",
                      {
                        "Ref": "AWS::Region"
                      },
                      " --role ",
                      {
                        "Ref": "RoleParam"
                      },
                      "\n"
                    ]
                  ]
                }
              },
              "c:\\Trend\\install.properties": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "AddressAndPortsScreen.ManagerAddress=",
                      {
                        "Ref": "AddressAndPortsScreenManagerAddress"
                      },
                      "\n",
                      "AddressAndPortsScreen.NewNode=",
                      {
                        "Ref": "AddressAndPortsScreenNewNode"
                      },
                      "\n",
                      "UpgradeVerificationScreen.Overwrite=",
                      {
                        "Ref": "UpgradeVerificationScreenOverwrite"
                      },
                      "\n",
                      "LicenseScreen.License=",
                      {
                        "Ref": "LicenseScreenLicense"
                      },
                      "\n",
                      "DatabaseScreen.DatabaseType=",
                      {
                        "Ref": "DatabaseScreenDatabaseType"
                      },
                      "\n",
                      "DatabaseScreen.Password=",
                      {
                        "Ref": "DatabaseScreenPassword"
                      },
                      "\n",
                      "AddressAndPortsScreen.ManagerPort=",
                      {
                        "Ref": "AddressAndPortsScreenManagerPort"
                      },
                      "\n",
                      "AddressAndPortsScreen.HeartbeatPort=",
                      {
                        "Ref": "AddressAndPortsScreenHeartbeatPort"
                      },
                      "\n",
                      "CredentialsScreen.Administrator.Username=",
                      {
                        "Ref": "CredentialsScreenAdministratorUsername"
                      },
                      "\n",
                      "CredentialsScreen.Administrator.Password=",
                      {
                        "Ref": "CredentialsScreenAdministratorPassword"
                      },
                      "\n",
                      "CredentialsScreen.UseStrongPasswords",
                      {
                        "Ref": "CredentialsScreenUseStrongPasswords"
                      },
                      "\n",
                      "SecurityUpdateScreen.UpdateComponents=",
                      {
                        "Ref": "SecurityUpdateScreenUpdateComponents"
                      },
                      "\n",
                      "SoftwareUpdateScreen.UpdateSoftware=",
                      {
                        "Ref": "SoftwareUpdateScreenUpdateSoftware"
                      },
                      "\n",
                      "CCredentialsScreen.UseStrongPasswords=",
                      {
                        "Ref": "CredentialsScreenUseStrongPasswords"
                      },
                      "\n",
                      "SecurityUpdateScreen.UpdateComponents=",
                      {
                        "Ref": "SecurityUpdateScreenUpdateComponents"
                      },
                      "\n",
                      "RelayScreen.Install=",
                      {
                        "Ref": "RelayScreenInstall"
                      },
                      "\n",
                      "SmartProtectionNetworkScreen.EnableFeedback=",
                      {
                        "Ref": "SmartProtectionNetworkScreenEnableFeedback"
                      },
                      "\n"
                    ]
                  ]
                }
              },
              "C:\\Trend\\Manager-Windows-9.6.1589.x64.exe": {
                "source": "https://s3-ap-southeast-2.amazonaws.com/cloudtrek-customers-deployment/TrendMicro/Manager-Windows-9.6.1589.x64.exe",
                "authentication": "RoleAccess"
              }
            },
            "commands": {
              "1-TrendInstall": {
                "command": "C:\\Trend\\Manager-Windows-9.6.1589.x64.exe -q -console -Dinstall4j.language=en -varfile install.properties"
              },
              "services": {
                "windows": {
                  "cfn-hup": {
                    "enabled": "true",
                    "ensureRunning": "true",
                    "files": [
                      "c:\\cfn\\cfn-hup.conf",
                      "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                    ]
                  }
                }
              }
            }
          }
        }
      },
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "RoleParam"
        },
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegion2AMI",
            {
              "Ref": "AWS::Region"
            },
            "Windows2012r2"
          ]
        },
        "SubnetId": {
          "Ref": "SubnetId"
        },
        "SecurityGroupIds": {
          "Ref": "SecurityGroup"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "<script>\n",
                "cfn-init.exe -v -s ",
                {
                  "Ref": "AWS::StackId"
                },
                " -r TrendManager",
                " --region ",
                {
                  "Ref": "AWS::Region"
                },
                " --role ",
                {
                  "Ref": "RoleParam"
                },
                "\n",
                "</script>"
              ]
            ]
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "Name"
            }
          },
          {
            "Key": "Customer",
            "Value": {
              "Ref": "Customer"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "TrendManagerIP": {
      "Value": {
        "Fn::GetAtt": [
          "TrendManager",
          "PrivateIp"
        ]
      },
      "Description": "IP Address for the Trend Manager"
    },
    "InstanceID": {
      "Value": {
        "Ref": "TrendManager"
      }
    }
  }
}
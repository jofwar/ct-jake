{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"AWS CloudFormation Template to create a Custom Server for MUE.",
  "Parameters":{
    "KeyName":{
      "Description":"Name of an existing EC2 KeyPair to enable SSH access to the Custom Server",
      "Type":"AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription":"must be the name of an existing EC2 KeyPair."
    },
    "InstanceType":{
      "Description":"Custom Server EC2 instance type",
      "Type":"String",
      "Default":"t2.medium",
      "AllowedValues":[
        "t2.micro",
        "t2.small",
        "t2.medium"
      ],
      "ConstraintDescription":"must be a valid EC2 instance type."
    },
    "VpcId":{
      "Type":"AWS::EC2::VPC::Id",
      "Description":"VpcId of your existing Virtual Private Cloud (VPC)"
    },
    "Name": {
      "Description": "Name TAG to allocate costs to",
      "Type": "String"
    },
    "Customer": {
      "Description" :"Customer TAG to allocate costs to",
      "Type": "String"
    },
    "Environment": {
      "Description" :"Environment TAG to allocate costs to",
      "Type": "String"
    },
    "SecurityGroups":{
      "Description":"Security group to apply to the Custom Server",
      "Type":"List<AWS::EC2::SecurityGroup::Id>"
    },
    "Subnet":{
      "Description":"Subnet to deploy the Custom Server into",
      "Type":"AWS::EC2::Subnet::Id"
    },
    "IAMRole":{
      "Description":"IAM Role to attach to the EC2 instance",
      "Type":"String"
    }
  },
  "Mappings": {
    "SubnetConfig": {
      "SCCWebServersA": {
        "CIDR": "3.0/28"
      },
      "SCCWebServersB": {
        "CIDR": "3.16/28"
      }
    },
    "AvailabilityZones":{
      "ap-southeast-2":{
        "ZoneA":"ap-southeast-2a",
        "ZoneB":"ap-southeast-2b"
      },
      "eu-west-1":{
        "ZoneA":"eu-west-1a",
        "ZoneB":"eu-west-1b"
      }
    },
    "AWSInstanceType2Arch":{
      "t2.micro":{
        "Arch":"HVM64"
      },
      "t2.small":{
        "Arch":"HVM64"
      },
      "t2.medium":{
        "Arch":"HVM64"
      }
    },
    "AWSRegionArch2AMI":{
      "ap-southeast-2":{
        "HVM64":"ami-6c14310f"
      }
    }
  },
  "Resources": {
    "SCCWebIPAddress":{
      "Type":"AWS::EC2::EIP",
      "Properties":{
        "Domain":"vpc",
        "InstanceId": {"Ref": "WebServerInstance" }
      }
    },
    "WebServerInstance": {
      "Type": "AWS::EC2::Instance",
       "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegionArch2AMI",
            {
              "Ref": "AWS::Region"
            },
            {
              "Fn::FindInMap": [
                "AWSInstanceType2Arch",
                {
                  "Ref": "InstanceType"
                },
                "Arch"
              ]
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "IAMRole"
        },
        "SecurityGroupIds": {
          "Ref" : "SecurityGroups"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "SubnetId": {
          "Ref": "Subnet"
        },
         "Tags": [
           {
             "Key": "Name",
             "Value": {
               "Ref": "Name"
             }
           },
           {
             "Key": "Environment",
             "Value": {
               "Ref": "Environment"
             }
           },
           {
             "Key": "Customer",
             "Value": {
               "Ref": "Customer"
             }
           }
         ]
      }
    }
  },
  "Outputs": {
    "SCCWebServer": {
      "Value": {
        "Ref": "WebServerInstance"
      },
      "Description": "MUE Custom Server's Instance ID"
    },
    "EIP":{
      "Value": {
        "Ref": "SCCWebIPAddress"
      },
      "Description": "The EIP created for this instance"
    }
  }
}

